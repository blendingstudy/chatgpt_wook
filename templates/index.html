<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <title>GPT</title>
    <style>
      html, body {
        height: 100%;
      }
      .full {
        height: 100%;
      }
      .container-fluid {
        height: 100%;
      }
      .chat-list {
        height: 100%;
        background-color: rgb(37, 37, 37);
        color:antiquewhite;
      }
      .chat-area {
        height: 100%;
        background-color: rgb(70, 70, 70);
      }
      .chat-history {
        height: 90%;
        margin: 5px;
      }
      .chat-typing {
        margin: 5px;
      }
      #message-input {
        width:100%;
      }
      .form-row {
        margin: 5px;
      }
      
      /* get */
      .message-container {
            max-width: 800px;
            margin: auto;
            margin-bottom: 1rem;
        }

        .message-box {
            border-radius: 10px;
            padding: 10px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-message {
            text-align: right;
        }

        .user-message .message-box {
            background-color: #fbe83d;
            color: #212529;
        }

        .ai-message {
            text-align: left;
        }

        .ai-message .message-box {
            background-color: #f8f9fa;
            color: #212529;
        }

        .name-label {
            display: block;
            /* font-weight: bold; */
            margin-bottom: 5px;
            color: #898989;
        }

        .chat-item {
          height: 30px;
          border: 1px solid;
          border-color: #898989;
          border-radius: 5px;
          margin-top: 5px;
          text-align : center;
          color:rgb(70, 70, 70)
        }

        .chat-item:hover {
          color: gray;
          cursor : pointer
        }

        .clicked {
          color:red;
        }

        pre {
            margin: 0;
            padding: 0;
            white-space: pre-wrap;
            background-color: transparent;
            border: none;
        }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row full">
        <div class="col-md-2 chat-list" id="chat-list">
          <button class="btn btn-outline-secondary" style="width:100%;margin-top:15px" onclick="newChat()"> + New chat</button>
        </div>
        <div class="col-md-10 chat-area">
          <div class="chat-history" id="chat-container" style="overflow:scroll">
            <!-- chat-history -->
          </div>
          <div class="chat-typing">
            <form id="message-form" style="width:100%;">
              <div class="form-row">
                <div class="col-11">
                  <input type="text" class="form-control" id="message-input" placeholder="Send a message" aria-label="Recipient's username" aria-describedby="button-addon2">
                </div>
                <div class="col-auto">
                  <button class="btn btn-outline-secondary" type="submit" id="button-addon2">send</button>
                </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script>

      function isCodeSnippet(message) {
        const codePattern = /(?:```)([^\n]+)(?:\n)((?:.|\n)*?)(?:```)/gm;
        return codePattern.test(message);
      }

      function formatCodeSnippet(message) {
        const codePattern = /(?:```)([^\n]+)(?:\n)((?:.|\n)*?)(?:```)/gm;
        return message.replace(codePattern, '<pre>$2</pre>');
      }

      $.fn.hasScrollBar = function() {
        return (this.prop("scrollHeight") == 0 && this.prop("clientHeight") == 0) || (this.prop("scrollHeight") > this.prop("clientHeight"));
      }

      function newChat() {
        $("#chat-list").append("<div class='chat-item' onclick='clickChat(e)'>new chat</div>")
      }

      function clickChat(e) {
        this.addClass("clicked")
      }

      function addMessage(content, isUser) {
        const className = isUser ? "user-message" : "ai-message";
        const name = isUser ? "Me" : "GPTChat";
        const nameLabel = $("<div>").addClass("name-label").text(name);
        const messageBox = $("<pre>").addClass("message-box");
        const messageContainer = $("<div>").addClass("message-container " + className);
        const formattedContent = isCodeSnippet(content) ? formatCodeSnippet(content) : content;
        messageBox.html(formattedContent);
        messageContainer.append(nameLabel).append(messageBox);
        $("#chat-container").append(messageContainer);
        if($('#chat-container').hasScrollBar()) {
          $('#chat-container').animate({
            scrollTop: $('#chat-container')[0].scrollHeight
          }, 400);
        }
      }

      function loadChatHistory() {
        $.ajax({
          url: "/chat_history",
          method: "GET",
          success: function(chatHistory) {
              for (const message of chatHistory) {
                  addMessage(message.content, message.role === "user");
              }
          },
          error: function() {
              console.error("Error: Could not load chat history.");
          }
        });
      }

      $(document).ready(function() {
        loadChatHistory();

        $("#message-form").submit(function(event) {
          event.preventDefault();

          const message = $("#message-input").val();
          addMessage(message, true);

          $.ajax({
              url: "/message",
              method: "POST",
              contentType: "application/json",
              data: JSON.stringify({ message: message }),
              success: function(response) {
                  addMessage(response.response, false);
              },
              error: function() {
                  addMessage("Error: Could not get a response.", false);
              }
          });
          $("#message-input").val("");
        });
      });
    </script>
  </body>
</html>